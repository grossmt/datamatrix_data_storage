# Протокол обмена данными между Сервером Сбора Данных и Контроллером Сканера

## Основные определения:

**`ССД`** - программно-аппаратный комплекс на базе персонального или промышленного компьютера для приема данных от контроллера сканера, а также для контроля состояния контроллера и смены настроек контроллера

**`КС`** - устройство для считывания 2D кодов и передачи считанных кодов на удаленный сервер хранения данных.

---

## Типы пакетов между `ССД` и `КС`:

### 1. Пакет контроля состояния.

**Запрос**: Пакет от `ССД`

| Название поля |     Преамбула     | Уникальный<br>ID КС |   ID<br>Пакета   | Код пакета |   Резерв    |
| ------------- | :---------------: | :-----------------: | :--------------: | :--------: | :---------: |
| Размер, байты |         6         |          2          |        2         |     1      |      4      |
| Содержимое    |      RFLABC       |       0x0001        | инкрементируется |    0x37    | 0x00000000  |
| Байткод       | 52 46 4C 41 42 43 |        00 01        |      00 01       |     37     | 00 00 00 00 |

52 46 4C 41 42 43 00 01 00 01 37 00 00 00 00

**Ответ**: Пакет от `КС`:

| Название поля |     Преамбула     | Уникальный<br>ID КС | ID<br>Пакета | Код пакета |   Резерв    |
| ------------- | :---------------: | :-----------------: | :----------: | :--------: | :---------: |
| Размер, байты |         6         |          2          |      2       |     1      |      4      |
| Содержимое    |      RFLABC       |       0x0001        | = ID запроса |    0x37    | 0x00000000  |
| Байткод       | 52 46 4C 41 42 43 |        00 01        |    00 01     |     37     | 00 00 00 00 |

---

### 2. Пакет смены настроек

**Запрос**: Пакет от `ССД`

| Название поля | Преамбула | Уникальный<br>ID КС | ID<br>пакета | Код пакета | Данные настроек |
| ------------- | --------- | ------------------- | ------------ | ---------- | --------------- |
| Размер, байты | 6         | 2                   | 2            | 1          | 256             |
| Содержимое    | RFLABC    | 0x0001              | = ID запроса | 0x13       | см. настройки   |

**Настройки:**

| Содержимое<br>поля | Продукт<br>#1 | Продукт<br>#2 | Продукт<br>#3 | Продукт<br>#4 | Продукт<br>#5 | Продукт<br>#6 | IP-адрес<br>КС | Порт<br>КС | IP-адрес<br>шлюза | Маска<br>подсети | Резерв |
| ------------------ | :-----------: | :-----------: | :-----------: | :-----------: | :-----------: | :-----------: | :------------: | :--------: | :---------------: | :--------------: | :----: |
| Размер,<br>байты   |      32       |      32       |      32       |      32       |      32       |      32       |       4        |     2      |         4         |        4         |   50   |

Поля `продукт` кодируют имена продуктов, которые возможны на данной точке конвеера.

Положение имени продукта в поле данных однозначно определяет его код - `Product ID`

Кодировка имени в `Win1251` с поддержкой кириллицы.

Если имя продукта короче 32 байт, то оставшиеся байты заполняются нулями.

В случае установки какого-либо параметра в 0, соответствующий параметр не будет изменятся на КС.

**Ответ**: Пакет от `КС`:

| Название поля | Преамбула | Уникальный<br>ID КС | ID пакета    | Код пакета | Статус применения настроек            |
| ------------- | --------- | ------------------- | ------------ | ---------- | ------------------------------------- |
| Размер, байты | 6         | 2                   | 2            | 1          | 4                                     |
| Содержимое    | RFLABC    | 0x0001              | = ID запроса | 0x13       | 0 - нет ошибок.<br>1..N - код ошибки. |

---

### 3. Пакет запроса архивных данных

**Запрос**: Пакет от `КС`

| Название поля | Преамбула | Уникальный<br>ID КС | ID<br>пакета     | Код пакета | Данные архива |
| ------------- | --------- | ------------------- | ---------------- | ---------- | ------------- |
| Размер, байты | 6         | 2                   | 2                | 1          | Не более 2048 |
| Содержимое    | RFLABC    | 0x0001              | инкрементируется | 0x45       |               |

Архивные данные:

| Название поля | Код<br>продукта | Длина<br>пакета | Количество<br>записей | Длина<br>записи #1 | Запись<br>#1 | ... | Длина<br>записи #N | Запись<br>#N |
| ------------- | --------------- | --------------- | --------------------- | ------------------ | ------------ | --- | ------------------ | ------------ |
| Размер, байты | 1               | 2               | 2                     | 1                  | 2            |     | 1                  | 2            |

**Пояснение**:

Предположим, что пришло 2 записи длиной общей длиной 17 байт.

Архивные данные будут выглядеть следующим образом:

| Код<br>продукта<br>`Product ID` | Длина<br>пакета | Количество<br>записей | Длина<br>записи #1 | Запись #1                               | Длина<br>записи #2 | Запись #2                                    |
| ------------------------------- | --------------- | --------------------- | ------------------ | --------------------------------------- | ------------------ | -------------------------------------------- |
| 0x01                            | 0x13            | 0x02                  | 0x08               | 0x01 0x23 0x45 0x67 0x89 0xAB 0xCD 0x0D | 0x09               | 0xFE 0xDC 0xBA 0x98 0x76 0x54 0x32 0x10 0x0D |


**Ответ**: Пакет от `ССД`:

| Название поля | Преамбула | Уникальный<br>ID КС | ID<br>пакета | Код пакета | Код ошибки                            |
| ------------- | --------- | ------------------- | ------------ | ---------- | ------------------------------------- |
| Размер, байты | 6         | 2                   | 2            | 1          | 4                                     |
| Содержимое    | RFLABC    | 0x0001              | = ID запроса | 0x45       | 0 - нет ошибок.<br>1..N - код ошибки. |
